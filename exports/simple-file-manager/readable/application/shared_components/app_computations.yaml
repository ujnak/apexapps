---
- # ====== Application Computation: G_DOWNLOAD_URL =============
  id: 14524599029888042
  identification: 
    item-name: G_DOWNLOAD_URL

  execution: 
    sequence: 10
    point: New Session

  computation: 
    type: Function Body
    language: PL/SQL
    pl/sql-function-body: |
      /*
       * 簡易URLがONのときにAPEX_UTIL.HOST_URL('SCRIPT')が正しい値を
       * 返さないことがある。以下はそのワークアラウンドとしての実装も含む。
       */
      declare
          l_download_url varchar2(800);
          l_apex_path    varchar2(400);
          l_pattern      varchar2(100);
          l_alias        varchar2(200);
      begin
          /* https://ホスト名:ポート番号/ords まで。 */
          l_apex_path := apex_util.host_url('APEX_PATH');
          /* ORDS別名を取得する。通常はワークスペース名に一致する。 */
          select pattern into l_pattern from user_ords_schemas
          where parsing_schema = sys_context('USERENV','CURRENT_USER');
          /*
           * アプリケーション別名。 日本語の対応を行なっているが効果は未確認。 
           * 本来はAPEX_URL.HOST_URL('SCRIPT')はここまでの文字列を返す。
          　*/
          l_alias := utl_url.escape(lower(:APP_ALIAS), false, 'AL32UTF8');
          /* 全体としてのURL */
          l_download_url := l_apex_path || 'r/' || l_pattern || '/' || l_alias || '/download?id=';
          return l_download_url;
      end;

