---
# ====== Page: ホーム ========================================
id: 1
identification: 
  name: ホーム
  alias: HOME
  title: ChatGPT App

appearance: 
  page-mode: Normal
  page-template: Theme Default
  template-options: 
  - '#DEFAULT#'

navigation-menu: 
  override-user-interface-level: false

navigation: 
  cursor-focus: Do not focus cursor
  warn-on-unsaved-changes: true

security: 
  authentication: Page Requires Authentication
  deep-linking: Application Default
  page-access-protection: Arguments Must Have Checksum
  form-auto-complete: Off
  browser-cache: Application Default

session-management: 
  rejoin-sessions: Application Default

advanced: 
  enable-duplicate-page-submissions: Yes - Enable page to be re-posted
  reload-on-submit: Only for Success

server-cache: 
  caching: Disabled

regions: 
- # ====== Region: System Message ==============================
  id: 58616187591087823
  identification: 
    title: System Message
    type: 静的コンテンツ

  layout: 
    sequence: 20
    parent-region: No Parent
    position: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Standard # 58974538280685262
    template-options: 
    - '#DEFAULT#'
    - t-Region--scrollBody
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: true
    exclude-title-from-translation: false

  server-side-condition: 
    type: No Rows returned
    sql-query: select * from apex_collections where collection_name = 'CHATGPT'

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      出力形式: HTML
      ショートカットを開く: false

- # ====== Region: Chat History ================================
  id: 58616630472087828
  identification: 
    title: Chat History
    type: カード

  source: 
    location: Local Database
    type: SQL Query
    sql-query: |
      select seq_id, c001, clob001, n001, n002, n003
      from apex_collections
      where collection_name = 'CHATGPT' order by seq_id desc

  layout: 
    sequence: 30
    parent-region: No Parent
    position: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Cards Container # 58915676136685233
    template-options: 
    - '#DEFAULT#'
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: true
    exclude-title-from-translation: false

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    id: 58616746843087829
    appearance: 
      layout: Horizontal (Row)

    card: 
      primary-key-column-1: SEQ_ID

    title: 
      advanced-formatting: false
      column: C001

    subtitle: 
      advanced-formatting: false

    body: 
      advanced-formatting: false
      column: CLOB001

    secondary-body: 
      advanced-formatting: true
      html-expression: |
        {if N001/}
        prompt_tokens: &N001. completion_tokens: &N002. total_tokens: &N003.
        {endif/}

    icon-and-badge: 
      icon-source: No Icon

    media: 
      advanced-formatting: false
      source: No Media

    performance: 
      lazy-loading: false

    pagination: 
      type: Scroll
      show-total-row-count: false

- # ====== Region: User Message ================================
  id: 58616804152087830
  identification: 
    title: User Message
    type: 静的コンテンツ

  layout: 
    sequence: 10
    parent-region: No Parent
    position: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Standard # 58974538280685262
    template-options: 
    - '#DEFAULT#'
    - t-Region--scrollBody
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: true
    exclude-title-from-translation: false

  server-side-condition: 
    type: Rows returned
    sql-query: select * from apex_collections where collection_name = 'CHATGPT'

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      出力形式: HTML
      ショートカットを開く: false

- # ====== Region: ChatGPT App =================================
  id: 59083474397685347
  identification: 
    title: ChatGPT App
    type: 静的コンテンツ

  layout: 
    sequence: 10
    parent-region: No Parent
    position: REGION_POSITION_01
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Hero # 58941583192685246
    template-options: 
    - '#DEFAULT#'
    render-components: Above Content

  image: 
    file-url: '#APP_FILES#icons/app-icon-512.png'

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: false
    exclude-title-from-translation: false

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      出力形式: HTML
      ショートカットを開く: false

page-items: 
- # ====== Page Item: P1_SYSTEM_MESSAGE ========================
  id: 58616274838087824
  identification: 
    name: P1_SYSTEM_MESSAGE
    type: テキスト・フィールド

  label: 
    label: System Message
    alignment: Left

  settings: 
    サブタイプ: Text
    空白の切捨て: Leading and Trailing
    テキストの大/小文字: 変更なし
    [enter]を押すと送信: false
    無効: false

  layout: 
    sequence: 10
    region: System Message # 58616187591087823
    position: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating # 59044999821685303
    template-options: 
    - '#DEFAULT#'
    width: 30

  validation: 
    value-required: false

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  default: 
    type: Static
    static-value: You are a helpful assistant.

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P1_USER_MESSAGE ==========================
  id: 58616982655087831
  identification: 
    name: P1_USER_MESSAGE
    type: テキスト領域

  label: 
    label: User Message
    alignment: Left

  settings: 
    サイズ変更可能: true
    高さ自動調整機能: false
    文字カウント機能: false
    空白の切捨て: Leading and Trailing

  layout: 
    sequence: 10
    region: User Message # 58616804152087830
    position: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating # 59044999821685303
    template-options: 
    - '#DEFAULT#'
    width: 30
    height: 5

  validation: 
    value-required: true

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: VARCHAR2
    storage: Per Request (Memory Only)

  quick-picks: 
    show-quick-picks: false

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P1_REQUEST ===============================
  id: 58618067307087842
  identification: 
    name: P1_REQUEST
    type: 表示のみ

  label: 
    label: Request
    alignment: Left

  settings: 
    書式: Plain Text
    基準: Item Value
    改行の表示: true
    ページの送信時に送信: false

  layout: 
    sequence: 40
    region: No Parent
    position: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating # 59044999821685303
    template-options: 
    - '#DEFAULT#'

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    data-type: CLOB
    storage: Per Session (Persistent)

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

buttons: 
- # ====== Button: SET_SYSTEM_MESSAGE ==========================
  id: 58616320724087825
  identification: 
    button-name: SET_SYSTEM_MESSAGE
    label: Set System Message

  layout: 
    sequence: 20
    region: System Message # 58616187591087823
    position: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    alignment: Left center

  appearance: 
    button-template: Text # 59047454270685304
    hot: false
    template-options: 
    - '#DEFAULT#'

  behavior: 
    action: Defined by Dynamic Action
    execute-validations: true

- # ====== Button: SEND_USER_MESSAGE ===========================
  id: 58617077876087832
  identification: 
    button-name: SEND_USER_MESSAGE
    label: Send User Message

  layout: 
    sequence: 20
    region: User Message # 58616804152087830
    position: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    alignment: Left center

  appearance: 
    button-template: Text # 59047454270685304
    hot: false
    template-options: 
    - '#DEFAULT#'

  behavior: 
    action: Defined by Dynamic Action
    execute-validations: true

- # ====== Button: INIT ========================================
  id: 58617404973087836
  identification: 
    button-name: INIT
    label: Start New Conversation

  layout: 
    sequence: 10
    region: ChatGPT App # 59083474397685347
    position: NEXT
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    button-template: Text # 59047454270685304
    hot: false
    template-options: 
    - '#DEFAULT#'

  behavior: 
    action: Redirect to Page in this Application
    target: 
      url: 'f?p=&APP_ID.:1:&SESSION.:INIT_CONVERSATION:&DEBUG.:::'
      page: 1 # ホーム
      request: INIT_CONVERSATION

    warn-on-unsaved-changes: Do Not Check

dynamic-actions: 
- # ====== Dynamic Action: onClick Set System Message ==========
  id: 58616487450087826
  identification: 
    name: onClick Set System Message

  execution: 
    sequence: 10

  when: 
    event: EVENT.EVENT.BROWSER.CLICK
    selection-type: Button
    button: SET_SYSTEM_MESSAGE # 58616320724087825

  execution: 
    event-scope: Static
    type: Immediate

  actions: 
  - # ====== Action: サーバー側のコードを実行 ====================
    id: 58616589871087827
    identification: 
      action: サーバー側のコードを実行

    settings: 
      言語: PE.PROPERTY.SOURCE_SNIPPET_LANG.LOV.PLSQL.D
      pl/sqlコード: |
        begin
            apex_collection.add_member(
                p_collection_name => 'CHATGPT'
                ,p_c001 => 'system'
                ,p_clob001 => :P1_SYSTEM_MESSAGE
            );
        end;
      送信するアイテム: 
      - P1_SYSTEM_MESSAGE

    execution: 
      sequence: 10
      event: onClick Set System Message # 58616487450087826
      fire-when-event-result-is: True
      fire-on-initialization: false
      stop-execution-on-error: true
      wait-for-result: true

  - # ====== Action: ページの送信 ================================
    id: 58617524890087837
    identification: 
      action: ページの送信

    settings: 
      処理中を表示: true

    execution: 
      sequence: 20
      event: onClick Set System Message # 58616487450087826
      fire-when-event-result-is: True
      fire-on-initialization: false

- # ====== Dynamic Action: onClick Send User Message ===========
  id: 58617161789087833
  identification: 
    name: onClick Send User Message

  execution: 
    sequence: 20

  when: 
    event: EVENT.EVENT.BROWSER.CLICK
    selection-type: Button
    button: SEND_USER_MESSAGE # 58617077876087832

  execution: 
    event-scope: Static
    type: Immediate

  actions: 
  - # ====== Action: サーバー側のコードを実行 ====================
    id: 58617238092087834
    identification: 
      action: サーバー側のコードを実行

    settings: 
      言語: PE.PROPERTY.SOURCE_SNIPPET_LANG.LOV.PLSQL.D
      pl/sqlコード: |
        declare
            l_request  json_object_t;
            l_request_clob clob;
            l_messages json_array_t;
            l_message  json_object_t;
            /*
            　　* OpenAIのドキュメントより、APIの応答例を拝借。
             * 参考: https://platform.openai.com/docs/guides/chat
             */
            l_response_clob clob := q'~{
         'id': 'chatcmpl-6p9XYPYSTTRi0xEviKjjilqrWU2Ve',
         'object': 'chat.completion',
         'created': 1677649420,
         'model': 'gpt-3.5-turbo',
         'usage': {'prompt_tokens': 56, 'completion_tokens': 31, 'total_tokens': 87},
         'choices': [
           {
            'message': {
              'role': 'assistant',
              'content': 'The 2020 World Series was played in Arlington, Texas at the Globe Life Field, which was the new home stadium for the Texas Rangers.'},
            'finish_reason': 'stop',
            'index': 0
           }
          ]
        }~';
            l_response json_object_t;
            l_choices json_array_t;
            l_role    varchar2(80);
            l_content clob;
            l_usage json_object_t;
        begin
            /*
            　　* ユーザーによるメッセージをコレクションに追記する。
             */
            apex_collection.add_member(
                p_collection_name => 'CHATGPT'
                ,p_c001 => 'user'
                ,p_clob001 => :P1_USER_MESSAGE
            );
            /*
             * ChatGPTのAPIに送信するメッセージを作成する。
             */
            /*
            　　* APEXコレクションCHATGPTより、作成時刻の昇順でメッセージの配列にする。
             */
            l_messages := json_array_t();
            for r in (select c001, clob001 from apex_collections where collection_name = 'CHATGPT' order by seq_id)
            loop
                l_message := json_object_t();
                l_message.put('role'   ,r.c001);
                l_message.put('content',r.clob001);
                l_messages.append(l_message);
            end loop;
            l_request := json_object_t();
            l_request.put('model','gpt-3.5-turbo');
            l_request.put('messages', l_messages);
            /* 
             * temprature, top_pなどのパラメータを設定するとしたら、ここでputする。
             */
            l_request_clob := l_request.to_clob();
            /* デバッグのため、送信するメッセージをP1_REQUESTに書き込む。 */
            :P1_REQUEST := l_request_clob;
            /*
             * OpenAIのChatGPTのAPIを呼び出す。今の所、コメントアウト。
             *
             * 参照: https://openai.com/blog/introducing-chatgpt-and-whisper-apis
             * API Ref: https://platform.openai.com/docs/api-reference/chat
            */
            apex_web_service.clear_request_headers;
            apex_web_service.set_request_headers('Content-Type','application/json',p_reset => false);
            /*
            l_response_clob := apex_web_service.make_rest_request(
                p_url => 'https://api.openai.com/v1/chat/completions'
                ,p_http_method => 'POST'
                ,p_body => l_request_clob
                ,p_credential_static_id => 'OPENAI_API_KEY'
            );
            */
            /* ドキュメントに記載されているレスポンスで処理を継続する。 */
            l_response := json_object_t(l_response_clob);
            l_choices := l_response.get_array('choices');
            l_message := treat(treat(l_choices.get(0) as json_object_t).get('message') as json_object_t);
            l_role    := l_message.get_string('role');
            l_content := l_message.get_clob('content');
            /* usageも取り出す。 */
            l_usage := treat(l_response.get('usage') as json_object_t);
            /*
             * ChatGPTからの応答をAPEXコレクションに追記する。
             */
            apex_collection.add_member(
                p_collection_name => 'CHATGPT'
                ,p_c001 => l_role
                ,p_clob001 => l_content
                ,p_n001 => l_usage.get_number('prompt_tokens')
                ,p_n002 => l_usage.get_number('completion_tokens')
                ,p_n003 => l_usage.get_number('total_tokens')
            );
            /* ユーザーのメッセージを消去する */
            :P1_USER_MESSAGE := '';
        end;
      送信するアイテム: 
      - P1_USER_MESSAGE
      戻すアイテム: 
      - P1_REQUEST
      - P1_USER_MESSAGE
      変更イベントの禁止: false

    execution: 
      sequence: 10
      event: onClick Send User Message # 58617161789087833
      fire-when-event-result-is: True
      fire-on-initialization: false
      stop-execution-on-error: true
      wait-for-result: true

  - # ====== Action: リフレッシュ ================================
    id: 58617365118087835
    identification: 
      action: リフレッシュ

    affected-elements: 
      selection-type: Region
      region: Chat History # 58616630472087828

    execution: 
      sequence: 20
      event: onClick Send User Message # 58617161789087833
      fire-when-event-result-is: True
      fire-on-initialization: false

processes: 
- # ====== Process: Init Conversation ==========================
  id: 58616017829087822
  identification: 
    name: Init Conversation
    type: コードを実行

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      begin
          if not apex_collection.collection_exists('CHATGPT') then
              apex_collection.create_collection('CHATGPT');
          end if;
          if :REQUEST = 'INIT_CONVERSATION' then
              apex_collection.create_or_truncate_collection('CHATGPT');
              :P1_REQUEST := '';
          end if;
      end;

  execution: 
    sequence: 10
    point: Before Header
    run-process: Once Per Page Visit (default)

