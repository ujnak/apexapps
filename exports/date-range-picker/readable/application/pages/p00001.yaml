---
# ====== Page: ホーム ========================================
id: 1
identification: 
  name: ホーム
  alias: HOME
  title: 日付範囲ピッカー

appearance: 
  page-mode: Normal
  page-template: Theme Default
  template-options: 
  - '#DEFAULT#'

navigation-menu: 
  override-user-interface-level: false

navigation: 
  cursor-focus: Do not focus cursor
  warn-on-unsaved-changes: true

javascript: 
  function-and-global-variable-declaration: const DATE_FORMAT = "yyyy/mm/dd";
  execute-when-page-loads: |
    apex.item("P1_DATE_RANGE").dayFormatter = (iso8860DateString) => {
        // Parse the day being formatted using ISO8860
        const currentDate = apex.date.parse(iso8860DateString,
                                            "YYYY-MM-DD");
        const startDateValue = apex.items.P1_DATE_START.value;
        // Parse start date using start page item format
        const startDate = startDateValue ? 
            apex.date.parse(startDateValue,DATE_FORMAT) : null;
        const endDateValue = apex.items.P1_DATE_END.value;
        // Parse end date using end page item format
        const endDate = endDateValue ? 
            apex.date.parse(endDateValue,DATE_FORMAT) : null;
        
        let dateRangeClass = "";
        // 開始日の設定は必須。
        if (startDateValue) {
            // 開始日が処理対象である。
            if (apex.date.isSame(currentDate,startDate)) {
                // 開始日と終了日が同じであれば、スタイルdateRangeSingleDayを適用する。
                if (endDateValue && apex.date.isSame(currentDate,endDate)) {
                    dateRangeClass = "dateRangeSingleDay";
                }
                else {
                    dateRangeClass = "dateRangeStart";
                }
            }
            // 処理対象が開始日以外。
            else if (endDateValue) {
                // 処理対象が終了日であれば、スタイルdateRangeEndを適用する。
                if (apex.date.isSame(currentDate,endDate)) {
                    dateRangeClass = "dateRangeEnd"
                } else if (apex.date.isBetween(currentDate,startDate,endDate)) {
                    // 処理対象が開始日と終了日の間であればスタイルdateRangeMiddleを適用する。
                    dateRangeClass = "dateRangeMiddle";
                }
            }
            // それ以外はスタイルを適用しない。
        };
        return {
            disabled: false,
            class: dateRangeClass
        };
    };

css: 
  file-urls: 
  - '#APP_FILES#dateRangePicker#MIN#.css'

security: 
  authentication: Page Requires Authentication
  deep-linking: Application Default
  page-access-protection: Arguments Must Have Checksum
  form-auto-complete: Off
  browser-cache: Application Default

session-management: 
  rejoin-sessions: Application Default

advanced: 
  enable-duplicate-page-submissions: Yes - Enable page to be re-posted
  reload-on-submit: Only for Success

server-cache: 
  caching: Disabled

regions: 
- # ====== Region: 日付範囲 ====================================
  id: 58618214973087844
  identification: 
    title: 日付範囲
    type: 静的コンテンツ

  layout: 
    sequence: 10
    parent-region: No Parent
    position: BODY
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: 3

  appearance: 
    template: Blank with Attributes (No Grid) # 59242177168695005
    template-options: 
    - '#DEFAULT#'
    render-components: Above Content

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: true
    exclude-title-from-translation: false

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      出力形式: HTML
      ショートカットを開く: false

- # ====== Region: 日付範囲ピッカー ============================
  id: 59415752767695141
  identification: 
    title: 日付範囲ピッカー
    type: 静的コンテンツ

  layout: 
    sequence: 10
    parent-region: No Parent
    position: REGION_POSITION_01
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic

  appearance: 
    template: Hero # 59273754195695023
    template-options: 
    - '#DEFAULT#'
    render-components: Above Content

  image: 
    file-url: '#APP_FILES#icons/app-icon-512.png'

  accessibility: 
    use-landmark: true
    landmark-type: Template Default

  advanced: 
    region-display-selector: false
    exclude-title-from-translation: false

  server-cache: 
    caching: Disabled

  customization: 
    customizable: Not Customizable By End Users

  attributes: 
    settings: 
      出力形式: HTML
      ショートカットを開く: false

page-items: 
- # ====== Page Item: P1_DATE_RANGE ============================
  id: 58618176600087843
  identification: 
    name: P1_DATE_RANGE
    type: 日付ピッカー

  label: 
    label: 日付範囲
    alignment: Left

  settings: 
    時間の表示: false
    表示形式: Inline
    最小日付: None
    最大日付: None
    複数月: No
    デフォルトの使用: false
    外観と動作: 'MONTH-PICKER:YEAR-PICKER:CLEAR-BUTTON'
    月の範囲外の日: Visible
    表示条件: Item Focus

  layout: 
    sequence: 20
    region: No Parent
    position: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: false
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating # 59377167266695085
    template-options: 
    - '#DEFAULT#'
    width: 30

  validation: 
    value-required: false

  advanced: 
    css-classes: 
    - date-range-picker
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P1_DATE_START ============================
  id: 58618371559087845
  identification: 
    name: P1_DATE_START
    type: テキスト・フィールド

  label: 
    label: Date Start
    alignment: Left

  settings: 
    サブタイプ: Text
    空白の切捨て: Leading and Trailing
    テキストの大/小文字: 変更なし
    [enter]を押すと送信: false
    無効: false

  layout: 
    sequence: 10
    region: 日付範囲 # 58618214973087844
    position: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating # 59377167266695085
    template-options: 
    - '#DEFAULT#'
    width: 30

  validation: 
    value-required: false

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

- # ====== Page Item: P1_DATE_END ==============================
  id: 58618449712087846
  identification: 
    name: P1_DATE_END
    type: テキスト・フィールド

  label: 
    label: Date End
    alignment: Left

  settings: 
    サブタイプ: Text
    空白の切捨て: Leading and Trailing
    テキストの大/小文字: 変更なし
    [enter]を押すと送信: false
    無効: false

  layout: 
    sequence: 20
    region: 日付範囲 # 58618214973087844
    position: BODY
    alignment: Left
    start-new-layout: false
    start-new-row: true
    column: Automatic
    new-column: true
    column-span: Automatic
    label-column-span: Page Template Default

  appearance: 
    template: Optional - Floating # 59377167266695085
    template-options: 
    - '#DEFAULT#'
    width: 30

  validation: 
    value-required: false

  advanced: 
    warn-on-unsaved-changes: Page Default

  source: 
    type: Null
    used: Only when current value in session state is null

  session-state: 
    storage: Per Session (Persistent)

  quick-picks: 
    show-quick-picks: false

  security: 
    session-state-protection: Unrestricted
    store-value-encrypted-in-session-state: true
    restricted-characters: All characters can be saved.

dynamic-actions: 
- # ====== Dynamic Action: onClick Specific Date ===============
  id: 58618527588087847
  identification: 
    name: onClick Specific Date

  execution: 
    sequence: 10

  when: 
    event: EVENT.EVENT.BROWSER.CHANGE
    selection-type: Item(s)
    item(s): 
    - P1_DATE_RANGE

  execution: 
    event-scope: Static
    type: Immediate

  actions: 
  - # ====== Action: JavaScriptコードの実行 ======================
    id: 58618667245087848
    identification: 
      action: JavaScriptコードの実行

    settings: 
      コード: |
        /*
         * 影響を受ける要素として、開始日と終了日のページ・アイテムを設定する。
         * 開始日のページ・アイテムを先に設定する。
         */
        let dateItemStart = this.affectedElements[0];
        let dateItemEnd = this.affectedElements[1];
        let dateItemClicked = this.triggeringElement;
        
        /*
         * 値が設定されていないときは、クリアがクリックされている。
         * 開始日と終了日をクリアして、リフレッシュする。
         */
        if (!dateItemClicked.value) {
            dateItemStart.value = "";
            dateItemEnd.value = "";
            dateItemClicked.refresh();
            return;
        }
        
        if (!dateItemStart.value) {
            // 開始日が未設定なので、選択された値は開始日として扱う。
            dateItemStart.value = dateItemClicked.value;
            if (!dateItemEnd.value) {
                /*
                 * 終了日も未設定なので、同じ日付を終了日に設定する。
                 * 開始日と終了日が同じ日であることを禁止する場合は、この処理を変更する。
                 */
                dateItemEnd.value = dateItemClicked.value;
            }
            // 開始日が未設定で終了日が設定されていることは無いはず。なので無視する。
        }
        else
        {
            // 開始日はすでに設定されている。
            const dateClicked = apex.date.parse(dateItemClicked.value, DATE_FORMAT);
            const dateStart   = apex.date.parse(dateItemStart.value, DATE_FORMAT);
            if (!dateItemEnd.value) {
                // 終了日が設定されていない。
                if (apex.date.isBefore(dateClicked, dateStart)) {
                     // 選択した日付が開始日より前であれば、開始日と終了日を入れ替えて期間を設定する。
                    dateItemEnd.value     = dateItemStart.value;
                    dateItemStart.value   = dateItemClicked.value;
                }
                else
                {
                    /*
                     * 終了日を設定する。
                     * 日付の範囲を正しく表示させるため、このページ・アイテムには開始日を設定する。
                     */
                    dateItemEnd.value = dateItemClicked.value;
                }
            }
            else
            {
                // 開始日と終了日の両方が設定済み。
                const dateEnd = apex.date.parse(dateItemEnd.value, DATE_FORMAT);
                if (apex.date.isBefore(dateClicked, dateStart)) {
                    // 開始日より前の日付を選択したときは開始日を変更する。
                    dateItemStart.value = dateItemClicked.value;
                } else if (apex.date.isAfter(dateClicked, dateEnd)) {
                    // 終了日より後の日付を選択したときは終了日を変更する。
                    dateItemEnd.value = dateItemClicked.value;
                } else if (apex.date.isBetween(dateClicked, dateStart, dateEnd)) {
                    // 開始日と終了日の間の日付を選択したときは、終了日を変更する。
                    dateItemEnd.value = dateItemClicked.value;
                    // 開始日を後ろに移動するには、一旦クリアする。
                }
            }
            /*
             * このページ・アイテムにはつねに開始日を設定したのちにリフレッシュを行う。
             * 日付の範囲を正しく表示するために必要。
             */
            dateItemClicked.value = dateItemStart.value;
            dateItemClicked.refresh();
        }

    affected-elements: 
      selection-type: Item(s)
      item(s): 
      - P1_DATE_START
      - P1_DATE_END

    execution: 
      sequence: 10
      event: onClick Specific Date # 58618527588087847
      fire-when-event-result-is: True
      fire-on-initialization: false

